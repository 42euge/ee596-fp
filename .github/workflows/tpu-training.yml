name: TPU Training CI

on:
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      num_steps:
        description: 'Number of training steps'
        default: '10'
        type: string
      tpu_type:
        description: 'TPU accelerator type'
        default: 'v5litepod-4'
        type: choice
        options:
          - v5litepod-1
          - v5litepod-4
          - v5litepod-8
          - v5litepod-16

env:
  TPU_NAME: ci-training-${{ github.run_id }}
  TPU_ZONE: us-central1-a
  GCP_PROJECT: kaggle-euge
  TPU_TYPE: ${{ github.event.inputs.tpu_type || 'v5litepod-4' }}
  NUM_STEPS: ${{ github.event.inputs.num_steps || '10' }}

jobs:
  tpu-training:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT }}

      - name: Create TPU VM
        id: create-tpu
        run: |
          echo "Creating TPU VM: $TPU_NAME (type: $TPU_TYPE)"

          gcloud compute tpus tpu-vm create $TPU_NAME \
            --project=$GCP_PROJECT \
            --zone=$TPU_ZONE \
            --accelerator-type=$TPU_TYPE \
            --version=v2-alpha-tpuv5-lite \
            --preemptible

          echo "tpu_created=true" >> $GITHUB_OUTPUT

      - name: Wait for TPU VM to be ready
        run: |
          echo "Waiting for TPU VM to be ready..."
          sleep 30

          # Wait for SSH to be available
          for i in {1..10}; do
            if gcloud compute tpus tpu-vm ssh $TPU_NAME \
              --project=$GCP_PROJECT \
              --zone=$TPU_ZONE \
              --command="echo 'TPU VM is ready'" 2>/dev/null; then
              echo "TPU VM is ready!"
              break
            fi
            echo "Attempt $i: TPU VM not ready yet, waiting..."
            sleep 15
          done

      - name: Copy code to TPU VM
        run: |
          # Create a tarball of the repository
          tar -czf /tmp/repo.tar.gz -C $GITHUB_WORKSPACE .

          # Copy to TPU VM
          gcloud compute tpus tpu-vm scp /tmp/repo.tar.gz $TPU_NAME:~/repo.tar.gz \
            --project=$GCP_PROJECT \
            --zone=$TPU_ZONE

          # Extract on TPU VM
          gcloud compute tpus tpu-vm ssh $TPU_NAME \
            --project=$GCP_PROJECT \
            --zone=$TPU_ZONE \
            --command="mkdir -p ~/training && tar -xzf ~/repo.tar.gz -C ~/training"

      - name: Setup TPU VM environment
        run: |
          gcloud compute tpus tpu-vm ssh $TPU_NAME \
            --project=$GCP_PROJECT \
            --zone=$TPU_ZONE \
            --command="cd ~/training && bash scripts/setup_tpu_vm.sh"

      - name: Configure HuggingFace auth
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          # Write token to temp file and scp to TPU VM
          echo "${HF_TOKEN}" > /tmp/hf_token.txt
          gcloud compute tpus tpu-vm scp /tmp/hf_token.txt $TPU_NAME:~/hf_token.txt \
            --project=$GCP_PROJECT \
            --zone=$TPU_ZONE
          rm /tmp/hf_token.txt

          # Use the token file to login
          gcloud compute tpus tpu-vm ssh $TPU_NAME \
            --project=$GCP_PROJECT \
            --zone=$TPU_ZONE \
            --command="source ~/venv/bin/activate && huggingface-cli login --token \$(cat ~/hf_token.txt) && rm ~/hf_token.txt"

      - name: Run training
        run: |
          gcloud compute tpus tpu-vm ssh $TPU_NAME \
            --project=$GCP_PROJECT \
            --zone=$TPU_ZONE \
            --command="cd ~/training && source ~/venv/bin/activate && python scripts/train_small.py --num-steps $NUM_STEPS"

      - name: Cleanup TPU VM
        if: always()
        run: |
          echo "Cleaning up TPU VM: $TPU_NAME"
          gcloud compute tpus tpu-vm delete $TPU_NAME \
            --project=$GCP_PROJECT \
            --zone=$TPU_ZONE \
            --quiet || echo "TPU VM cleanup failed or VM doesn't exist"
